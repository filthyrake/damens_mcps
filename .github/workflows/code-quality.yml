name: Code Quality Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

permissions:
  contents: read

jobs:
  code-quality-pfsense:
    name: Code Quality - pfSense MCP
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    
    - name: Install quality tools and dependencies
      run: |
        cd pfsense-mcp
        pip install -r requirements.txt
        pip install 'black>=24.1.0' 'isort>=5.13.0' 'flake8>=7.0.0' 'mypy>=1.8.0' 'bandit>=1.7.6' 'safety>=3.0.0' 'interrogate>=1.5.0'
    
    - name: Format check with black
      run: |
        cd pfsense-mcp
        black --check src/ tests/ --line-length=120
      continue-on-error: true
    
    - name: Import sort check with isort
      run: |
        cd pfsense-mcp
        isort --check-only src/ tests/ --profile black --line-length=120
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        cd pfsense-mcp
        flake8 src/ tests/ --max-line-length=120 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Type check with mypy
      run: |
        cd pfsense-mcp
        mypy src/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true
    
    - name: Security scan with bandit
      run: |
        cd pfsense-mcp
        bandit -r src/ -ll -f txt
      continue-on-error: true
    
    - name: Dependency vulnerability scan with safety
      run: |
        cd pfsense-mcp
        safety check --json
      continue-on-error: true
    
    - name: Documentation coverage with interrogate
      run: |
        cd pfsense-mcp
        interrogate src/ -vv --fail-under=40
      continue-on-error: true

  code-quality-truenas:
    name: Code Quality - TrueNAS MCP
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    
    - name: Install quality tools and dependencies
      run: |
        cd truenas-mcp
        pip install -r requirements.txt
        pip install 'black>=24.1.0' 'isort>=5.13.0' 'flake8>=7.0.0' 'mypy>=1.8.0' 'bandit>=1.7.6' 'safety>=3.0.0' 'interrogate>=1.5.0'
    
    - name: Format check with black
      run: |
        cd truenas-mcp
        black --check src/ tests/ --line-length=120
      continue-on-error: true
    
    - name: Import sort check with isort
      run: |
        cd truenas-mcp
        isort --check-only src/ tests/ --profile black --line-length=120
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        cd truenas-mcp
        flake8 src/ tests/ --max-line-length=120 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Type check with mypy
      run: |
        cd truenas-mcp
        mypy src/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true
    
    - name: Security scan with bandit
      run: |
        cd truenas-mcp
        bandit -r src/ -ll -f txt
      continue-on-error: true
    
    - name: Dependency vulnerability scan with safety
      run: |
        cd truenas-mcp
        safety check --json
      continue-on-error: true
    
    - name: Documentation coverage with interrogate
      run: |
        cd truenas-mcp
        interrogate src/ -vv --fail-under=40
      continue-on-error: true

  code-quality-idrac:
    name: Code Quality - iDRAC MCP
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    
    - name: Install quality tools and dependencies
      run: |
        cd idrac-mcp
        pip install -r requirements.txt
        pip install 'black>=24.1.0' 'isort>=5.13.0' 'flake8>=7.0.0' 'mypy>=1.8.0' 'bandit>=1.7.6' 'safety>=3.0.0' 'interrogate>=1.5.0'
    
    - name: Format check with black
      run: |
        cd idrac-mcp
        black --check src/ tests/ --line-length=120
      continue-on-error: true
    
    - name: Import sort check with isort
      run: |
        cd idrac-mcp
        isort --check-only src/ tests/ --profile black --line-length=120
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        cd idrac-mcp
        flake8 src/ tests/ --max-line-length=120 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Type check with mypy
      run: |
        cd idrac-mcp
        mypy src/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true
    
    - name: Security scan with bandit
      run: |
        cd idrac-mcp
        bandit -r src/ -ll -f txt
      continue-on-error: true
    
    - name: Dependency vulnerability scan with safety
      run: |
        cd idrac-mcp
        safety check --json
      continue-on-error: true
    
    - name: Documentation coverage with interrogate
      run: |
        cd idrac-mcp
        interrogate src/ -vv --fail-under=40
      continue-on-error: true

  code-quality-proxmox:
    name: Code Quality - Proxmox MCP
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
    
    - name: Install quality tools and dependencies
      run: |
        cd proxmox-mcp
        pip install -r requirements.txt
        pip install 'black>=24.1.0' 'isort>=5.13.0' 'flake8>=7.0.0' 'mypy>=1.8.0' 'bandit>=1.7.6' 'safety>=3.0.0' 'interrogate>=1.5.0'
    
    - name: Format check with black
      run: |
        cd proxmox-mcp
        black --check src/ tests/ --line-length=120
      continue-on-error: true
    
    - name: Import sort check with isort
      run: |
        cd proxmox-mcp
        isort --check-only src/ tests/ --profile black --line-length=120
      continue-on-error: true
    
    - name: Lint with flake8
      run: |
        cd proxmox-mcp
        flake8 src/ tests/ --max-line-length=120 --extend-ignore=E203,W503
      continue-on-error: true
    
    - name: Type check with mypy
      run: |
        cd proxmox-mcp
        mypy src/ --ignore-missing-imports --no-strict-optional
      continue-on-error: true
    
    - name: Security scan with bandit
      run: |
        cd proxmox-mcp
        bandit -r src/ -ll -f txt
      continue-on-error: true
    
    - name: Dependency vulnerability scan with safety
      run: |
        cd proxmox-mcp
        safety check --json
      continue-on-error: true
    
    - name: Documentation coverage with interrogate
      run: |
        cd proxmox-mcp
        interrogate src/ -vv --fail-under=40
      continue-on-error: true
